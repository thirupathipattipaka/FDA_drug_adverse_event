---
title: "AdverseDrugReactions"
author: "Thirupathi Pattipaka"
date: "7/2/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("/Users/thirupathipattipaka/OtherProjects/FDA_drug_adverse_event")
```

## Introduction

The U.S. Food and Drug Administration (FDA) regulates over-the- counter and prescription drugs in the United States, including biological therapeutics and generic drugs. This work covers more than just medicines. For example, fluoride toothpaste, antiperspirants, dandruff shampoos and sunscreens are all considered drugs.

<br>

An adverse event is submitted to the FDA to report any undesirable experience associated with the use of a medical product in a patient. For drugs, this includes serious drug side effects, product use errors, product quality problems, and therapeutic failures for prescription or over-the- counter medicines and medicines administered to hospital patients or at outpatient infusion centers.

<br>

The FDA's database of adverse event reports is made available through a web API at https://open.fda.gov/drug/event/. Each report contains general information about the report, patient information, a list of the drugs that the patient is taking, and a list of the patient reactions. It is possible to use these data in many ways: your brief is to explore these data and to see what might be learned from them.

The analysis is aimed to:

* Are different adverse events reported in different countries?
* What are the different adverse events associated with different disease areas?
* What drugs tend to be taken together?

# Loading list of libraries
```{r}
library(jsonlite)
library(dplyr)
library(stringi)
library(ggplot2)
library(downloader)
library(lubridate)
```

## Downloading data from openfda (JSON files)

Downloading the data

```{r}
# for (i in 1:87) { 
#   if (i<10){
#     url = paste0("https://download.open.fda.gov/drug/event/all_other/drug-event-000",i,"-of-0087.json.zip")
#   }
#   else{
#     url = paste0("https://download.open.fda.gov/drug/event/all_other/drug-event-00",i,"-of-0087.json.zip")
#   }
#   download(url,dest="json.zip")
#   unzip ("json.zip")
#   }
```

```{r}
dir()
```
```{r}
filenames <- list.files(pattern="*.json", full.names=TRUE)
filenames
```

```{r}
drug1 = fromJSON(filenames[75])
```

```{r}
names(drug1)
```

```{r}
drug1$meta
```
```{r}
results=drug1$results
class(results)
```

```{r}
glimpse(results)
```

```{r}
patient <- results$patient
glimpse(patient)
```

```{r}
patient$reaction_d <- as.data.frame(as.matrix(patient$reaction))
```

```{r}
glimpse(results$primarysource)
```


## Merging the data

```{r}
#drugname
drugname <-  NULL

for (i in 1:15000) { 
  drugname <- rbind(drugname, results$patient$drug[[i]][["medicinalproduct"]] %>% paste( collapse=","))
}


#drugindication
drugindication <- NULL

for (i in 1:15000) { 
  drugindication <- rbind(drugindication, results$patient$drug[[i]][["drugindication"]] %>% paste( collapse=","))
}

AE <- NULL
for (i in 1:15000) { 
  AE <- rbind (AE, results$patient$reaction[[i]][["reactionmeddrapt"]] %>%  unlist() %>% paste(collapse=","))
  }

df <-  cbind(results[,!(names(results) %in% c("patient","sender","receiver","primarysource","reportduplicate"))],
             results$patient[,!(names(results$patient) %in% c("reaction","drug","patientdeath","summary"))],
             results$primarysource,
             drugname = drugname,
             drugindication= drugindication,
             AE = AE)

```

```{r,warnings=FALSE}
library(gtools)
for(j in 76:87){                      # read all the rest
      
      tmp =fromJSON(filenames[j])$results
      #drugname
      drugname <-  NULL

      for (i in 1:nrow(tmp)) { 
          drugname <- rbind(drugname, tmp$patient$drug[[i]][["medicinalproduct"]] %>% paste( collapse=","))
      }


      #drugindication
      drugindication <- NULL

      for (i in 1:nrow(tmp)) { 
          drugindication <- rbind(drugindication, tmp$patient$drug[[i]][["drugindication"]] %>% paste( collapse=","))
      }
      
      AE <- NULL
      for (i in 1:nrow(tmp)) { 
          AE <- rbind (AE, tmp$patient$reaction[[i]][["reactionmeddrapt"]] %>%  unlist() %>% paste(collapse=","))
       }
      #df.new <-  cbind(tmp,tmp$patient,tmp$primarysource,drugname = drugname,drugindication= drugindication)
      df_new <-  cbind(tmp[,!(names(tmp) %in% c("patient","sender","receiver","primarysource","reportduplicate"))],
                       tmp$patient[,!(names(tmp$patient) %in% c("reaction","drug","patientdeath","summary"))],
                       tmp$primarysource,
                       drugname = drugname,
                       drugindication= drugindication,
                       AE = AE)

   df=smartbind(df, df_new)  # concatenate all
}
```

```{r}
glimpse(df)
```

## Top 100 Adverse drug reactions
```{r}
library(knitr)
df %>% select(AE) %>% table() %>% sort(... = 2,decreasing = TRUE) %>% as.data.frame() %>% head(100) %>%  kable()
```

## Adverse events by country
```{r}
df %>% select(occurcountry) %>% table() %>% sort(... = 2,decreasing = TRUE) %>% as.data.frame() %>% head(100) %>%  kable(caption="Adverse events in different countries")
```

## Top drugs
```{r}
df %>% select(drugname) %>% table() %>% sort(... = 2,decreasing = TRUE) %>% as.data.frame() %>% head(100) %>%  kable()
```

# Top diseases
```{r}
df %>% select(drugindication) %>% table() %>% sort(... = 2,decreasing = TRUE) %>% as.data.frame() %>% head(100) %>%  kable()
```


```{r}
#categorization of source country
df <- df %>% mutate(occurcountry_g = case_when(.$occurcountry=='US'~"United states",
                                                .$occurcountry=='JP'~"Japan",
                                                .$occurcountry=='GB'~"Great Britain",
                                                .$occurcountry=='FR'~"France"
                                                ))
df$occurcountry_g <- ifelse(is.na(df$occurcountry_g),"Other",df$occurcountry_g)
#table(df$AE,df$occurcountry_g)
#top AEs in US
df %>% filter(occurcountry=='US') %>% select(AE) %>% table() %>% sort(... = 2,decreasing = TRUE) %>% as.data.frame() %>% head(100) %>%  kable(caption="US)

```

